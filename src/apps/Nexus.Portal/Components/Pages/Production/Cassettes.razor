@page "/production/cassettes"
@using System
@using System.Collections.Generic
@using System.Diagnostics
@using System.Linq
@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@using Nexus.Core.Domain.Models.Locations
@using Nexus.Core.Domain.Models.Locations.Base
@using Nexus.Core.Domain.Models.Locations.Enums
@using Nexus.Core.Domain.Models.Locations.Interfaces
@using Nexus.Core.Domain.Models.Transports
@using Nexus.Core.Domain.Models.Transports.DTO
@inject ITransportRepository TransportRepository
@inject ILocationRepository LocationRepository
@inject IDialogService DialogService
@inject ILogger<Cassettes> Logger

<MudPaper Class="pa-4">
    @if (_isLoading)
    {
        <div class="d-flex justify-center align-center" style="height: 400px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                <MudText Typo="Typo.subtitle1">데이터를 불러오는 중입니다...</MudText>
            </MudStack>
        </div>
    }
    else
    {
        <MudTable T="CassetteViewModel"
                  Items="@GetFilteredCassettes()"
                  Dense="true"
                  Hover="true"
                  Bordered="true"
                  Striped="true"
                  Elevation="1"
                  RowsPerPage="20"
                  RowsPerPageOptions="@(new int[] { 10, 20, 50 })">
            <ToolBarContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="w-100">
                    <MudText Typo="Typo.h6">Cassette Overview</MudText>
                    <MudTextField @bind-Value="_searchTerm"
                                  Placeholder="카세트 또는 위치 검색"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  IconSize="Size.Medium"
                                  Immediate="true"
                                  Margin="Margin.Dense"
                                  Style="max-width: 280px; width: 100%;" />
                </MudStack>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Cassette</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Location</MudTh>
                <MudTh>Tray Usage</MudTh>
                <MudTh>Memory Usage</MudTh>
                <MudTh Align="Right">Actions</MudTh>
            </HeaderContent>
            <RowTemplate Context="cassette">
                <MudTd DataLabel="Cassette">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Inventory2" Color="Color.Primary" />
                        <MudText Typo="Typo.body2">@cassette.Cassette.Id</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Name">
                    @if (!string.IsNullOrWhiteSpace(cassette.Cassette.Name))
                    {
                        <MudText Typo="Typo.body2">@cassette.Cassette.Name</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">이름 없음</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Location">
                    @if (!string.IsNullOrEmpty(cassette.LocationId))
                    {
                        <MudChip T="string" Color="Color.Info" Variant="Variant.Outlined">@cassette.LocationId</MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">미배정</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Tray Usage">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.body2">@string.Format("{0} / {1}", cassette.TrayCount, cassette.Cassette.MaxTrayCapacity)</MudText>
                        <MudProgressLinear Value="@CalculateTrayUsagePercent(cassette)" Color="Color.Primary" Rounded="true" />
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Memory Usage">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.body2">@string.Format("{0} / {1}", GetMemoryCount(cassette), cassette.Cassette.MaxMemoryCapacity)</MudText>
                        <MudProgressLinear Value="@CalculateMemoryUsagePercent(cassette)" Color="Color.Secondary" Rounded="true" />
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Actions" Align="Right">
                    <MudTooltip Text="위치 변경">
                        <MudIconButton Icon="@Icons.Material.Filled.Place"
                                      Color="Color.Primary"
                                      OnClick="@(() => ChangeLocationAsync(ELocationType.Cassette, cassette.Cassette.Id, cassette.LocationId))" />
                    </MudTooltip>
                    <MudTooltip Text="위치 해제">
                        <MudIconButton Icon="@Icons.Material.Filled.HighlightOff"
                                      Color="Color.Secondary"
                                      Disabled="@string.IsNullOrEmpty(cassette.LocationId)"
                                      OnClick="@(() => ClearLocationAsync(ELocationType.Cassette, cassette.Cassette.Id, cassette.LocationId))" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
            <ChildRowContent Context="cassetteDetail">
                <MudTd ColSpan="6">
                    <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2">트레이 상세</MudText>
                            @if (cassetteDetail.Trays.Count == 0)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">등록된 트레이가 없습니다.</MudText>
                            }
                            else
                            {
                                @foreach (TrayViewModel tray in cassetteDetail.Trays)
                                {
                                    <MudPaper Class="pa-3 mb-3" Elevation="0" Style="border: 1px solid var(--mud-palette-lines-default);">
                                        <MudStack Spacing="1">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudIcon Icon="@Icons.Material.Filled.TableRows" Color="Color.Secondary" />
                                                    <MudText Typo="Typo.body2">@tray.Tray.Id</MudText>
                                                    @if (!string.IsNullOrEmpty(tray.LocationId))
                                                    {
                                                        <MudChip T="string" Color="Color.Info" Variant="Variant.Outlined">@tray.LocationId</MudChip>
                                                    }
                                                    else
                                                    {
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">미배정</MudText>
                                                    }
                                                </MudStack>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudTooltip Text="위치 변경">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Place"
                                                                      Color="Color.Primary"
                                                                      OnClick="@(() => ChangeLocationAsync(ELocationType.Tray, tray.Tray.Id, tray.LocationId))" />
                                                    </MudTooltip>
                                                    <MudTooltip Text="위치 해제">
                                                        <MudIconButton Icon="@Icons.Material.Filled.HighlightOff"
                                                                      Color="Color.Secondary"
                                                                      Disabled="@string.IsNullOrEmpty(tray.LocationId)"
                                                                      OnClick="@(() => ClearLocationAsync(ELocationType.Tray, tray.Tray.Id, tray.LocationId))" />
                                                    </MudTooltip>
                                                </MudStack>
                                            </MudStack>

                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @string.Format("메모리 {0} / {1}", tray.Memories.Count, tray.Tray.MaxMemoryCapacity)
                                            </MudText>

                                            @if (tray.Memories.Count == 0)
                                            {
                                                <MudText Typo="Typo.body2" Color="Color.Secondary">등록된 메모리가 없습니다.</MudText>
                                            }
                                            else
                                            {
                                                <MudTable T="MemoryViewModel" Items="@tray.Memories" Dense="true" Hover="true" Bordered="true" Elevation="0">
                                                    <HeaderContent>
                                                        <MudTh>Memory ID</MudTh>
                                                        <MudTh>Device ID</MudTh>
                                                        <MudTh>Location</MudTh>
                                                        <MudTh Align="Right">Actions</MudTh>
                                                    </HeaderContent>
                                                    <RowTemplate>
                                                        <MudTd DataLabel="Memory ID">@context.Memory.Id</MudTd>
                                                        <MudTd DataLabel="Device ID">@context.Memory.DeviceId</MudTd>
                                                        <MudTd DataLabel="Location">
                                                            @if (!string.IsNullOrEmpty(context.LocationId))
                                                            {
                                                                <MudChip T="string" Color="Color.Info" Variant="Variant.Outlined">@context.LocationId</MudChip>
                                                            }
                                                            else
                                                            {
                                                                <MudText Typo="Typo.caption" Color="Color.Secondary">미배정</MudText>
                                                            }
                                                        </MudTd>
                                                        <MudTd Align="Right">
                                                            <MudTooltip Text="위치 변경">
                                                                <MudIconButton Icon="@Icons.Material.Filled.Place"
                                                                              Color="Color.Primary"
                                                                              OnClick="@(() => ChangeLocationAsync(ELocationType.Memory, context.Memory.Id, context.LocationId))" />
                                                            </MudTooltip>
                                                            <MudTooltip Text="위치 해제">
                                                                <MudIconButton Icon="@Icons.Material.Filled.HighlightOff"
                                                                              Color="Color.Secondary"
                                                                              Disabled="@string.IsNullOrEmpty(context.LocationId)"
                                                                              OnClick="@(() => ClearLocationAsync(ELocationType.Memory, context.Memory.Id, context.LocationId))" />
                                                            </MudTooltip>
                                                        </MudTd>
                                                    </RowTemplate>
                                                </MudTable>
                                            }
                                        </MudStack>
                                    </MudPaper>
                                }
                            }
                        </MudStack>
                    </MudPaper>
                </MudTd>
            </ChildRowContent>
            <NoRecordsContent>
                <MudText Typo="Typo.body1" Color="Color.Secondary">조건에 맞는 카세트가 없습니다.</MudText>
            </NoRecordsContent>
        </MudTable>
    }
</MudPaper>

@code {
    private bool _isLoading = true;
    private string _searchTerm = string.Empty;
    private List<CassetteViewModel> _cassettes = new List<CassetteViewModel>();
    private Dictionary<string, CassetteViewModel> _cassetteLookup = new Dictionary<string, CassetteViewModel>();
    private Dictionary<string, TrayViewModel> _trayLookup = new Dictionary<string, TrayViewModel>();
    private Dictionary<string, MemoryViewModel> _memoryLookup = new Dictionary<string, MemoryViewModel>();

    protected override async Task OnInitializedAsync()
    {
        await LoadCassetteDataAsync();
    }

    private async Task LoadCassetteDataAsync()
    {
        _isLoading = true;
        StateHasChanged();

        Stopwatch stopwatch = Stopwatch.StartNew();

        try
        {
            Task<IReadOnlyList<Location>> locationTask = LocationRepository.GetAllAsync();
            Task<CassetteHierarchyDto> hierarchyTask = TransportRepository.GetCassetteHierarchyAsync();

            await Task.WhenAll(locationTask, hierarchyTask);

            IReadOnlyList<Location> locations = await locationTask;
            CassetteHierarchyDto hierarchy = await hierarchyTask;

            Dictionary<string, string> locationMap = BuildLocationMap(locations);

            _cassettes.Clear();
            _cassetteLookup.Clear();
            _trayLookup.Clear();
            _memoryLookup.Clear();

            IEnumerable<Cassette> sortedCassettes = hierarchy.Cassettes.OrderBy(cassette => cassette.Id);
            foreach (Cassette cassette in sortedCassettes)
            {
                string cassetteLocationId = ResolveLocationId(locationMap, cassette.Id);
                CassetteViewModel cassetteView = new CassetteViewModel(cassette, cassetteLocationId);
                _cassettes.Add(cassetteView);
                _cassetteLookup[cassette.Id] = cassetteView;

                if (hierarchy.CassetteTrays.TryGetValue(cassette.Id, out IReadOnlyList<Tray>? trays) && trays != null)
                {
                    IEnumerable<Tray> sortedTrays = trays.OrderBy(tray => tray.Id);
                    foreach (Tray tray in sortedTrays)
                    {
                        string trayLocationId = ResolveLocationId(locationMap, tray.Id);
                        TrayViewModel trayView = new TrayViewModel(tray, trayLocationId);
                        cassetteView.Trays.Add(trayView);
                        _trayLookup[tray.Id] = trayView;

                        if (hierarchy.TrayMemories.TryGetValue(tray.Id, out IReadOnlyList<Memory>? memories) && memories != null)
                        {
                            IEnumerable<Memory> sortedMemories = memories.OrderBy(memory => memory.Id);
                            foreach (Memory memory in sortedMemories)
                            {
                                string memoryLocationId = ResolveLocationId(locationMap, memory.Id);
                                MemoryViewModel memoryView = new MemoryViewModel(memory, memoryLocationId);
                                trayView.Memories.Add(memoryView);
                                _memoryLookup[memory.Id] = memoryView;
                            }
                        }
                    }
                }
            }

            stopwatch.Stop();
            Logger.LogInformation("Cassettes page data loaded in {ElapsedMilliseconds} ms", stopwatch.ElapsedMilliseconds);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load cassette data.");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private static Dictionary<string, string> BuildLocationMap(IReadOnlyList<Location> locations)
    {
        Dictionary<string, string> locationMap = new Dictionary<string, string>();
        foreach (Location location in locations)
        {
            if (string.IsNullOrEmpty(location.CurrentItemId))
            {
                continue;
            }

            if (!locationMap.ContainsKey(location.CurrentItemId))
            {
                locationMap[location.CurrentItemId] = location.Id;
            }
        }

        return locationMap;
    }

    private static string ResolveLocationId(Dictionary<string, string> locationMap, string transportId)
    {
        if (locationMap.TryGetValue(transportId, out string? locationId))
        {
            return locationId;
        }

        return string.Empty;
    }

    private IEnumerable<CassetteViewModel> GetFilteredCassettes()
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
        {
            return _cassettes;
        }

        string search = _searchTerm.Trim();
        return _cassettes.Where(cassette =>
            cassette.Cassette.Id.Contains(search, StringComparison.OrdinalIgnoreCase) ||
            (!string.IsNullOrEmpty(cassette.LocationId) && cassette.LocationId.Contains(search, StringComparison.OrdinalIgnoreCase)));
    }

    private int GetMemoryCount(CassetteViewModel cassette)
    {
        int total = 0;
        foreach (TrayViewModel tray in cassette.Trays)
        {
            total += tray.Memories.Count;
        }

        return total;
    }

    private double CalculateTrayUsagePercent(CassetteViewModel cassette)
    {
        int capacity = cassette.Cassette.MaxTrayCapacity;
        if (capacity == 0)
        {
            return 0;
        }

        double trayCount = Convert.ToDouble(cassette.TrayCount);
        double trayCapacity = Convert.ToDouble(capacity);
        double percentage = (trayCount / trayCapacity) * 100.0;
        return Math.Round(percentage, 2);
    }

    private double CalculateMemoryUsagePercent(CassetteViewModel cassette)
    {
        int capacity = cassette.Cassette.MaxMemoryCapacity;
        if (capacity == 0)
        {
            return 0;
        }

        int memoryCount = GetMemoryCount(cassette);
        double used = Convert.ToDouble(memoryCount);
        double memoryCapacity = Convert.ToDouble(capacity);
        double percentage = (used / memoryCapacity) * 100.0;
        return Math.Round(percentage, 2);
    }

    private async Task ChangeLocationAsync(ELocationType locationType, string transportId, string? currentLocationId)
    {
        IReadOnlyList<Location> locations = await LocationRepository.GetLocationsByTypeAsync(locationType);
        List<string> availableLocationIds = new List<string>();
        foreach (Location location in locations)
        {
            if (string.IsNullOrEmpty(location.CurrentItemId))
            {
                availableLocationIds.Add(location.Id);
            }
        }

        DialogParameters parameters = new DialogParameters();
        parameters.Add("Title", "위치 변경");
        parameters.Add("Locations", availableLocationIds);

        string currentLocationValue = string.Empty;
        if (!string.IsNullOrEmpty(currentLocationId))
        {
            currentLocationValue = currentLocationId;
        }

        parameters.Add("CurrentLocationId", currentLocationValue);

        DialogOptions options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        IDialogReference dialog = await DialogService.ShowAsync<Nexus.Portal.Components.Dialogs.SelectLocationDialog>("위치 변경", parameters, options);
        DialogResult? result = await dialog.Result;
        if (result == null || result.Canceled)
        {
            return;
        }

        string? newLocationId = result.Data as string;
        if (!string.IsNullOrEmpty(newLocationId))
        {
            await ApplyLocationChangeAsync(locationType, transportId, currentLocationId, newLocationId);
        }
    }

    private async Task ClearLocationAsync(ELocationType locationType, string transportId, string? currentLocationId)
    {
        if (string.IsNullOrEmpty(currentLocationId))
        {
            return;
        }

        Location? location = await LocationRepository.GetByIdAsync(currentLocationId);
        if (location != null)
        {
            location.CurrentItemId = string.Empty;
            await LocationRepository.UpdateAsync(location);
        }

        UpdateLocationForTransport(locationType, transportId, string.Empty);
        StateHasChanged();
    }

    private async Task ApplyLocationChangeAsync(ELocationType locationType, string transportId, string? currentLocationId, string newLocationId)
    {
        if (!string.IsNullOrEmpty(currentLocationId))
        {
            Location? oldLocation = await LocationRepository.GetByIdAsync(currentLocationId);
            if (oldLocation != null)
            {
                oldLocation.CurrentItemId = string.Empty;
                await LocationRepository.UpdateAsync(oldLocation);
            }
        }

        Location? newLocation = await LocationRepository.GetByIdAsync(newLocationId);
        if (newLocation != null)
        {
            newLocation.CurrentItemId = transportId;
            await LocationRepository.UpdateAsync(newLocation);
            UpdateLocationForTransport(locationType, transportId, newLocationId);
            StateHasChanged();
        }
    }

    private void UpdateLocationForTransport(ELocationType locationType, string transportId, string locationId)
    {
        if (locationType == ELocationType.Cassette)
        {
            if (_cassetteLookup.TryGetValue(transportId, out CassetteViewModel? cassette))
            {
                cassette.LocationId = locationId;
            }
            return;
        }

        if (locationType == ELocationType.Tray)
        {
            if (_trayLookup.TryGetValue(transportId, out TrayViewModel? tray))
            {
                tray.LocationId = locationId;
            }
            return;
        }

        if (locationType == ELocationType.Memory)
        {
            if (_memoryLookup.TryGetValue(transportId, out MemoryViewModel? memory))
            {
                memory.LocationId = locationId;
            }
        }
    }

    private sealed class CassetteViewModel
    {
        public CassetteViewModel(Cassette cassette, string locationId)
        {
            Cassette = cassette;
            LocationId = locationId;
            Trays = new List<TrayViewModel>();
        }

        public Cassette Cassette { get; }
        public string LocationId { get; set; }
        public List<TrayViewModel> Trays { get; }

        public int TrayCount => Trays.Count;
    }

    private sealed class TrayViewModel
    {
        public TrayViewModel(Tray tray, string locationId)
        {
            Tray = tray;
            LocationId = locationId;
            Memories = new List<MemoryViewModel>();
        }

        public Tray Tray { get; }
        public string LocationId { get; set; }
        public List<MemoryViewModel> Memories { get; }
    }

    private sealed class MemoryViewModel
    {
        public MemoryViewModel(Memory memory, string locationId)
        {
            Memory = memory;
            LocationId = locationId;
        }

        public Memory Memory { get; }
        public string LocationId { get; set; }
    }
}
