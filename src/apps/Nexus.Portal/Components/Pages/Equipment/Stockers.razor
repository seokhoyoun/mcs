@page "/equipment/stocker"
@using MudBlazor
@using MudBlazor.Components
@using Nexus.Core.Domain.Models.Stockers
@using Nexus.Core.Domain.Models.Locations
@using Nexus.Core.Domain.Models.Locations.Enums
@inject Nexus.Core.Domain.Models.Stockers.Interfaces.IStockerRepository StockerRepository

<PageTitle>Stocker Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Stocker Management</MudText>
    <MudText Typo="Typo.subtitle1" Class="mb-4">Monitor stocker status and manage cassette ports</MudText>

    <MudGrid>
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">@(_stocker != null ? $"{_stocker.Id} - {_stocker.Name}" : "No stocker")</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Online</MudChip>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">Total Ports</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Primary">@_totalPorts</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">Occupied Ports</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Secondary">@_occupiedPorts</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">Utilization</MudText>
                            <MudProgressLinear Color="Color.Primary" Value="@_utilization" />
                            <MudText Typo="Typo.caption">@_utilization%</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">Last Inspection</MudText>
                            <MudText Typo="Typo.body2">-</MudText>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
                <MudCardActions>
                    <MudButton StartIcon="@Icons.Material.Filled.Settings" Color="Color.Primary">Settings</MudButton>
                    <MudButton StartIcon="@Icons.Material.Filled.Build" Color="Color.Secondary">Maintenance</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Cassette Port Map</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="port-map-compact">
                    <MudGrid Spacing="0">
                        @if (_portDetails.Count == 0)
                        {
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2">No port data.</MudText>
                            </MudItem>
                        }
                        else
                        {
                            @foreach (PortDetail detail in _portDetails)
                            {
                                <MudItem xs="4">
                                    <MudCard Outlined="true" Class="@($"{GetPortCardClass(detail)} port-compact-card")">
                                        <MudCardContent Class="pa-1">
                                            <MudText Typo="Typo.caption" Align="Align.Center">@detail.PortId</MudText>
                                            <MudText Typo="Typo.caption" Align="Align.Center">@GetPortStatus(detail)</MudText>
                                            <MudText Typo="Typo.caption" Align="Align.Center">@detail.CassetteId</MudText>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            }
                        }
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Cassette Port Details</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Items="@_portDetails" Hover="true" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Port ID</MudTh>
                            <MudTh>Position</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Cassette ID</MudTh>
                            <MudTh>Load Time</MudTh>
                            <MudTh>Next Action</MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Port ID">@context.PortId</MudTd>
                            <MudTd DataLabel="Position">@context.Position</MudTd>
                            <MudTd DataLabel="Status">@context.Status</MudTd>
                            <MudTd DataLabel="Cassette ID">@context.CassetteId</MudTd>
                            <MudTd DataLabel="Load Time">@context.LoadTime?.ToString("HH:mm:ss")</MudTd>
                            <MudTd DataLabel="Next Action">@context.NextAction</MudTd>
                            <MudTd DataLabel="Actions">
                                <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small">
                                    <MudButton StartIcon="@Icons.Material.Filled.Eject">Unload</MudButton>
                                    <MudButton StartIcon="@Icons.Material.Filled.Block">Block</MudButton>
                                </MudButtonGroup>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

<Nexus.Portal.Components.Layout.DockPortal>
   

    <MudDataGrid T="PortDetail"
                 Items="_portDetails"
                 Dense="true"
                 Hover="true"
                 Bordered="true"
                 Striped="true"
                 FixedHeader="true"
                 RowsPerPage="10"
                 Virtualize="false"
                 ReadOnly="true"
                 Hideable="true">
        <Columns>
            <PropertyColumn Property="x => x.PortId" Title="Port ID" Sortable="true" />
            <PropertyColumn Property="x => x.Position" Title="Position" Sortable="true" />
            <PropertyColumn Property="x => x.Status" Title="Status" Sortable="true" />
            <PropertyColumn Property="x => x.CassetteId" Title="Cassette ID" Sortable="true" />
            <TemplateColumn Title="Load Time" Sortable="true">
                <CellTemplate>
                    @if (context.Item.LoadTime.HasValue)
                    {
                        @context.Item.LoadTime.Value.ToString("HH:mm:ss")
                    }
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.NextAction" Title="Next Action" />
        </Columns>

        <PagerContent>
            <MudDataGridPager />
        </PagerContent>
    </MudDataGrid>
</Nexus.Portal.Components.Layout.DockPortal>

@code {
    private Stocker? _stocker;
    private List<PortDetail> _portDetails = new List<PortDetail>();
    private int _totalPorts = 0;
    private int _occupiedPorts = 0;
    private int _utilization = 0;

    protected override async Task OnInitializedAsync()
    {
        IReadOnlyList<Stocker> stockers = await StockerRepository.GetAllAsync();
        if (stockers != null)
        {
            if (stockers.Count > 0)
            {
                _stocker = stockers[0];
            }
        }

        if (_stocker != null)
        {
            BuildPortDetailsFromStocker(_stocker);
        }
    }

    private void BuildPortDetailsFromStocker(Stocker stocker)
    {
        _portDetails.Clear();

        foreach (CassetteLocation loc in stocker.CassetteLocations)
        {
            PortDetail detail = new PortDetail();
            detail.PortId = loc.Id;
            detail.Position = loc.Name;
            detail.Status = loc.Status.ToString();
            detail.CassetteId = string.IsNullOrEmpty(loc.CurrentItemId) ? string.Empty : loc.CurrentItemId;
            detail.LoadTime = null;
            detail.NextAction = string.Empty;
            _portDetails.Add(detail);
        }

        _totalPorts = _portDetails.Count;
        _occupiedPorts = _portDetails.Count(d => !string.IsNullOrEmpty(d.CassetteId));
        if (_totalPorts > 0)
        {
            _utilization = (int)Math.Round(100.0 * _occupiedPorts / _totalPorts);
        }
        else
        {
            _utilization = 0;
        }
    }

    private string GetPortCardClass(PortDetail detail)
    {
        string statusText = GetPortStatus(detail);
        if (statusText == "In Use")
        {
            return "mud-theme-success";
        }
        if (statusText == "Error")
        {
            return "mud-theme-error";
        }
        if (statusText == "Empty")
        {
            return "mud-theme-info";
        }
        return string.Empty;
    }

    private string GetPortStatus(PortDetail detail)
    {
        if (!string.IsNullOrEmpty(detail.CassetteId))
        {
            return "In Use";
        }

        if (string.Equals(detail.Status, ELocationStatus.OutOfService.ToString(), StringComparison.OrdinalIgnoreCase))
        {
            return "Error";
        }

        return "Empty";
    }

    public class PortDetail
    {
        public string PortId { get; set; } = string.Empty;
        public string Position { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string CassetteId { get; set; } = string.Empty;
        public DateTime? LoadTime { get; set; }
        public string NextAction { get; set; } = string.Empty;
    }
}
